<?xml version="1.0" standalone="no"?>

<kickstart>


	<description>
	Grid DataFarm Frontend support
	Ready to be configured to metadata server or/and file system server
	</description>

	<copyright>
	Copyright (c) 2000 - 2010 The Regents of the University of California.
	All rights reserved. Rocks(r) v5.4 www.rocksclusters.org
	
	</copyright>

	<changelog>
	$Log$
	Revision 1.22  2011/09/19 20:00:17  zhengc
	Add vm-deploy scripts
	
	Revision 1.21  2011/09/16 22:21:04  phil
	Firewall rules via the rocks database (5.4.3), should work for 5.4
	
	Revision 1.20  2011/09/16 22:17:11  phil
	permissions on fusermount
	
	Revision 1.19  2011/08/17 19:53:53  zhengc
	Fix file synchronization problem between frontend and compute nodes
	The files are: certificates directory and gfarm2.conf
	
	Revision 1.18  2011/08/12 00:00:14  zhengc
	New GFARM Roll
	
	</changelog>

	<package>gfarm2fs</package>
	<package>gfarm</package>
	<package>vdt</package>
	<package>vm-scripts</package>

        <package>fuse</package>
	<package>fuse-libs</package>
        <package>fuse-devel</package>

	<package>postgresql84</package>
	<package>postgresql84-libs</package>
	<package>postgresql84-server</package>
	<package>postgresql84-devel</package>
	<package>postgresql84-contrib</package>
	<package>postgresql84-docs</package>
	<package>postgresql84-plperl</package>
	<package>postgresql84-plpython</package>
	<package>postgresql84-pltcl</package>
	<package>postgresql84-python</package>
	<package>postgresql84-tcl</package>
	<package>postgresql84-test</package>

<post>

<!--
        The GFarm RPMs automatically adds the _gfarmfs user as a normal account
        with UID >= 500.  We also need the gfarm admin accout created.
        Here we make sure both UIDs are below 500.
-->
/usr/sbin/useradd -c "Gfarm gfsd" -u 423 _gfarmfs
/usr/sbin/useradd -c "Gfarm Admin" -u 424 gfarm


<file name="/etc/profile.d/gfarm.sh" perms="644">
export PATH="/opt/gfarm/bin:/opt/gfarm2fs/bin:$PATH"
</file>

<file name="/etc/rc.d/rocksconfig.d/post-50-gfarm.sh" perms="744">
#!/bin/sh

rpm -i /export/rocks/install/rocks-dist/x86_64/RedHat/RPMS/libxslt-1.1.17-2.el5_2.2.i386.rpm

source /opt/vdt/setup.sh
cp /opt/vdt/setup.sh /etc/profile.d/globus.sh
export PATH="/opt/gfarm/bin:$PATH"

mkdir -p /etc/grid-security
vdt-control --on
vdt-update-certs --force

crontab -l > /var/tmp/cron.out
echo "00 01 * * * /bin/tar -chf /etc/grid-security/certs.tar /etc/grid-security/certificates" >> /var/tmp/cron.out
crontab /var/tmp/cron.out
rm /var/tmp/cron.out
/bin/tar -chf /etc/grid-security/certs.tar /etc/grid-security/certificates
echo "FILES += /etc/grid-security/certs.tar /opt/gfarm/etc/gfarm2.conf" >> /var/411/Files.mk
rocks sync users

/opt/rocks/bin/rocks add firewall global=global action=ACCEPT chain=INPUT protocol=udp service=600 network=all rulename=A100-GFARM-UDP-600
/opt/rocks/bin/rocks add firewall global=global action=ACCEPT chain=INPUT protocol=tcp service=600 network=all rulename=A100-GFARM-TCP-600
/opt/rocks/bin/rocks add firewall global=global action=ACCEPT chain=INPUT protocol=tcp service=601 network=all rulename=A100-GFARM-TCP-601

config-gfarm -A gfarm -a gsi -X

mv /opt/gfarm/etc/gfarm2.conf /opt/gfarm/etc/gfarm2.conf.bak
sed 's/gsi/sharedsecret *\nauth enable gsi_auth/' /opt/gfarm/etc/gfarm2.conf.bak > /opt/gfarm/etc/gfarm2.conf
mv /opt/gfarm/etc/gfmd.conf /opt/gfarm/etc/gfmd.conf.bak
sed 's/gsi/sharedsecret *\nauth enable gsi_auth/' /opt/gfarm/etc/gfmd.conf.bak > /opt/gfarm/etc/gfmd.conf
/etc/init.d/gfarm-pgsql stop
/etc/init.d/gfmd stop
/etc/init.d/gfarm-pgsql start
/etc/init.d/gfmd start

sudo -u _gfarmfs gfkey -f -p 63072000
sudo -u gfarm gfkey -f -p 63072000
config-gfsd /state/partition1/gfarm
sudo -u gfarm \
	/opt/gfarm/bin/gfhost -c -a x86_64-rocks5.4-linux -p 600 -n 1 `hostname`
sudo -u gfarm gfgroup -m gfarmroot gfarm

/etc/init.d/gfmd stop
/etc/init.d/gfarm-pgsql stop
/sbin/chkconfig gfarm-pgsql off
/sbin/chkconfig gfmd off

rm /etc/rc.d/rocksconfig.d/post-50-gfarm
</file>
/bin/chmod o+rx /bin/fusermount
</post>

</kickstart>
