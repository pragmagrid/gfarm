#!/bin/bash
#
# vm-makeover <vm-name> <vm-image-full-path> <vm-mnt-full-path> <vm-hostname> <vm-ip> <netmask> <gateway>
#
# Modify VM image file then start VM. Should only be sudo-run by vm-deploy.
#
# V1.0 - 9/17/11, Cindy Zheng, zhengc@sdsc.edu
# 

if [ $# != 7 ];
then
  exit 1
fi

#
# Check VM mount point
#
if [ -d $3 ];
then
  /bin/mountpoint -q $3;
  if [ $? = 0 ];
  then
    /bin/umount $3;
    if [ $? != 0 ];
    then
      exit 2;
    fi
  fi
else
  /bin/mkdir $3
fi

#
# Chage the VM disk image path
#
/opt/rocks/bin/rocks set host vm $1 disk=file:$2,hda,w
if [ $? != 0 ];
then
# clean up?
  exit 3
fi

#
# Mount the disk image in user's home directory
#
/usr/bin/lomount -diskimage $2 -partition 1 $3
if [ $? != 0 ];
then
  exit 4
fi

#
# Modify VM disk image
#
# Modify grub file
#
line=$(/bin/grep "default=0" $3/boot/grub/grub.conf)
if [ -n "$line" ];
then
  /bin/sed -i 's/default=0/default=1/' $3/boot/grub/grub.conf
fi
#
# Modify ifcfg-eth0
#
/bin/sed -i 's/HWADDR/#HWADDR/' $3/etc/sysconfig/network-scripts/ifcfg-eth0
/bin/sed -i 's/IPADDR/#IPADDR/' $3/etc/sysconfig/network-scripts/ifcfg-eth0
/bin/sed -i 's/NETMASK/#NETMASK/' $3/etc/sysconfig/network-scripts/ifcfg-eth0
/bin/sed -i 's/BOOTPROTO/#BOOTPROTO/' $3/etc/sysconfig/network-scripts/ifcfg-eth0
/bin/echo "IPADDR=$5" >> $3/etc/sysconfig/network-scripts/ifcfg-eth0
/bin/echo "NETMASK=$6" >> $3/etc/sysconfig/network-scripts/ifcfg-eth0
/bin/echo "BOOTPROTO=static" >> $3/etc/sysconfig/network-scripts/ifcfg-eth0
#
# Get old hostname
#
vminfo=$(/bin/grep "^HOSTNAME" $3/etc/sysconfig/network)
if [ -z "$vminfo" ];
then
  echo "Warning: can't find the original hostname in /etc/sysconfig/network"
else
  oldhostfull=$(/bin/echo $vminfo | /bin/cut -d'=' -f2);
  oldhostshort=$(/bin/echo $oldhostfull | /bin/cut -d'.' -f1)
fi
#
# Get short new hostname
#
newhostshort=$(/bin/echo $4 | /bin/cut -d'.' -f1)
#
# Modify network file
#
/bin/sed -i 's/HOSTNAME/#HOSTNAME/' $3/etc/sysconfig/network
/bin/echo "HOSTNAME=$4" >> $3/etc/sysconfig/network
/bin/sed -i 's/GATEWAY/#GATEWAY/' $3/etc/sysconfig/network
/bin/echo "GATEWAY=$7" >> $3/etc/sysconfig/network
#
# Modify resolv.conf
#
/bin/cp /etc/resolv.conf $3/etc/resolv.conf
#
# Add root and user ssh public keys
#
/bin/cat /root/.ssh/*.pub >> $3/root/.ssh/authorized_keys
/bin/cat $HOME/.ssh/*.pub >> $3/root/.ssh/authorized_keys
#
# Modify hosts file
#
/bin/sed -i "s/$oldhostfull/$4/g" $3/etc/hosts
/bin/sed -i "s/$oldhostshort/$newhostshort/g" $3/etc/hosts
#
# Modify auto.home
#
/bin/sed -i "s/$oldhostshort/$newhostshort/g" $3/etc/auto.home
#
# Modify httpd.conf
#
/bin/sed -i "s/$oldhostfull/$4/g" $3/etc/httpd/conf/httpd.conf

/bin/umount $3

#
# Start VM
#
/opt/rocks/bin/rocks set host boot action=os $1
if [ $? != 0 ];
then
  exit 5
fi

/opt/rocks/bin/rocks start host vm $1
if [ $? != 0 ];
then
  exit 6
fi

exit 0
